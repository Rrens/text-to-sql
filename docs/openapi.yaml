openapi: 3.0.3
info:
  title: Text-to-SQL API
  description: |
    Production-ready Text-to-SQL API platform for converting natural language to SQL queries.

    ## Features
    - Multi-tenant workspaces
    - Multiple database support (PostgreSQL, ClickHouse, MySQL)
    - Multiple LLM providers (Ollama, OpenAI, Anthropic, DeepSeek)
    - Secure credential storage (AES-256-GCM)
    - Read-only SQL enforcement

    ## Authentication
    Use JWT Bearer tokens for authentication. Get tokens via `/auth/login`.
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:4081/api/v1
    description: Development server

tags:
  - name: Authentication
    description: User authentication endpoints
  - name: Workspaces
    description: Workspace management
  - name: Connections
    description: Database connection management
  - name: Query
    description: Text-to-SQL query execution
  - name: System
    description: Health check and system info

paths:
  /health:
    get:
      tags: [System]
      summary: Health check
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /ready:
    get:
      tags: [System]
      summary: Readiness check
      responses:
        "200":
          description: Service is ready
        "503":
          description: Service not ready

  /auth/register:
    post:
      tags: [Authentication]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: User registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/login:
    post:
      tags: [Authentication]
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          description: Invalid credentials

  /auth/refresh:
    post:
      tags: [Authentication]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          description: Invalid refresh token

  /cache/flush:
    post:
      tags: [System]
      summary: Flush schema cache
      description: Removes all cached schema data from Redis
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Cache flushed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: cache flushed successfully
                      keys_deleted:
                        type: integer
                        example: 5
        "401":
          description: Unauthorized

  /workspaces:
    get:
      tags: [Workspaces]
      summary: List user workspaces
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of workspaces
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Workspace"
    post:
      tags: [Workspaces]
      summary: Create workspace
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateWorkspaceRequest"
      responses:
        "201":
          description: Workspace created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkspaceResponse"

  /workspaces/{workspaceId}:
    parameters:
      - name: workspaceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Workspaces]
      summary: Get workspace
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Workspace details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkspaceResponse"
    patch:
      tags: [Workspaces]
      summary: Update workspace
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateWorkspaceRequest"
      responses:
        "200":
          description: Workspace updated
    delete:
      tags: [Workspaces]
      summary: Delete workspace
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Workspace deleted

  /workspaces/{workspaceId}/connections:
    parameters:
      - name: workspaceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Connections]
      summary: List connections
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of connections
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Connection"
    post:
      tags: [Connections]
      summary: Create connection
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateConnectionRequest"
      responses:
        "201":
          description: Connection created

  /workspaces/{workspaceId}/connections/{connectionId}:
    parameters:
      - name: workspaceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: connectionId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Connections]
      summary: Get connection
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Connection details
    patch:
      tags: [Connections]
      summary: Update connection
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Connection updated
    delete:
      tags: [Connections]
      summary: Delete connection
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Connection deleted

  /workspaces/{workspaceId}/connections/{connectionId}/schema:
    parameters:
      - name: workspaceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: connectionId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Connections]
      summary: Get database schema
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Database schema
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchemaResponse"

  /workspaces/{workspaceId}/query:
    parameters:
      - name: workspaceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags: [Query]
      summary: Execute text-to-SQL query
      description: Generate SQL from natural language and optionally execute it
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
      responses:
        "200":
          description: Query result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueryResponse"

  /workspaces/{workspaceId}/generate:
    parameters:
      - name: workspaceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags: [Query]
      summary: Generate SQL only
      description: Generate SQL from natural language without executing
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
      responses:
        "200":
          description: Generated SQL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueryResponse"

  /llm-providers:
    get:
      tags: [System]
      summary: List available LLM providers
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of LLM providers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LLMProvidersResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string

    HealthResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            status:
              type: string
              example: ok

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    UserResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            email:
              type: string

    TokenResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            access_token:
              type: string
            refresh_token:
              type: string
            expires_in:
              type: integer

    Workspace:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        settings:
          type: object
        created_at:
          type: string
          format: date-time

    CreateWorkspaceRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        settings:
          type: object

    UpdateWorkspaceRequest:
      type: object
      properties:
        name:
          type: string
        settings:
          type: object

    WorkspaceResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: "#/components/schemas/Workspace"

    Connection:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        database_type:
          type: string
          enum: [postgres, clickhouse, mysql]
        host:
          type: string
        port:
          type: integer
        database:
          type: string
        username:
          type: string
        ssl_mode:
          type: string
        read_only:
          type: boolean
        max_rows:
          type: integer

    CreateConnectionRequest:
      type: object
      required: [name, database_type, host, port, database, username, password]
      properties:
        name:
          type: string
        database_type:
          type: string
          enum: [postgres, clickhouse, mysql]
        host:
          type: string
        port:
          type: integer
        database:
          type: string
        username:
          type: string
        password:
          type: string
        ssl_mode:
          type: string
          enum: [disable, require, verify-ca, verify-full]
        read_only:
          type: boolean
          default: true
        max_rows:
          type: integer
          default: 1000
        timeout_seconds:
          type: integer
          default: 30

    SchemaResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            database_type:
              type: string
            tables:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  columns:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        data_type:
                          type: string
                        nullable:
                          type: boolean
                        primary_key:
                          type: boolean
            ddl:
              type: string

    QueryRequest:
      type: object
      required: [connection_id, question]
      properties:
        connection_id:
          type: string
          format: uuid
        question:
          type: string
          maxLength: 2000
        llm_provider:
          type: string
          enum: [openai, anthropic, ollama, deepseek, gemini]
        llm_model:
          type: string
        execute:
          type: boolean
          default: true
        options:
          type: object
          properties:
            max_rows:
              type: integer
            timeout_seconds:
              type: integer

    QueryResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            request_id:
              type: string
            question:
              type: string
            sql:
              type: string
            result:
              type: object
              properties:
                columns:
                  type: array
                  items:
                    type: string
                rows:
                  type: array
                  items:
                    type: array
                row_count:
                  type: integer
                truncated:
                  type: boolean
            error:
              type: string
            metadata:
              type: object
              properties:
                connection_id:
                  type: string
                database_type:
                  type: string
                llm_provider:
                  type: string
                llm_model:
                  type: string
                execution_time_ms:
                  type: integer
                llm_latency_ms:
                  type: integer
                tokens_used:
                  type: integer

    LLMProvidersResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            providers:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  models:
                    type: array
                    items:
                      type: string
                  default:
                    type: boolean
            default_provider:
              type: string
